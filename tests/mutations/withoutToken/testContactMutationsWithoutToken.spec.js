import { tester } from "graphql-tester";

const testing = tester({
  url: "https://api.dev.vipfy.store/graphql",
  method: "POST",
  contentType: "application/json"
});

const queryWrapper = function(query) {
  return '{"operationName":null,"variables":{},"query":"' + query + '"}';
};

const expectAuthError = function(response, queryName) {
  expect(response).toBeDefined();
  expect(response.success).toEqual(false);
  expect(response.status).toEqual(200);
  expect(response.errors).toHaveLength(1);
  expect(response.errors[0].name).toEqual("AuthError");

  if (response.data) {
    expect(response.data[queryName]).toEqual(null);
  } else expect(response.data).toEqual(null);
};
// prettier-ignore
var functionsWhichExpectAuthError = new Map([
  ["createAddress", ['(addressData: {})', "{id}"]],
  ["updateAddress", ['(id:1)', "{id}"]],
  ["deleteAddress", ['(id:159)', "{ok}"]],
  ["createEmail", ['(emailData:{email:\\"testmail@mail.com\\"})', "{email}"]],
  ["updateEmail", ['(email:\\"asd@asd.asd\\",emailData:{})', "{ok}"]], 
  ["updateEmail08", ['(email:\\"asd@asd.asd\\",emailData:{})', "{unitid{id} email verified autogenerated priority createdat}"]],
  ["deleteEmail", ['(email:\\"randomtestmail@mail.com\\")', "{ok}"]],
  ["createPhone", ['(phoneData:{id:1})', "{id}"]],
  ["updatePhone", ['(id:1)', "{id}"]],
  ["deletePhone", ['(id:1)', "{ok}"]],
  //["newsletterSignup", ['', ""]], //Test with (in)valid email, multiple signups? -> separate tests
  //["newsletterSignupConfirm", ['', ""]], -> separate tests
  //["searchAddress", ['', ""]], unauthorized user? -> Yes -> separate test
  //["contact", ['', ""]], -> separate test
]);

describe("Testing contact mutations without token", () => {
  for (let [func, [parameters, subfields]] of functionsWhichExpectAuthError) {
    it("testing " + func + ", expect AuthError", async () => {
      var query = `mutation{${func}${parameters}${subfields}}`;
      var response = await testing(queryWrapper(query));
      expectAuthError(response, func);
    });
  }

  it("testing searchAddress with random input, expect success", async () => {
    var query = `mutation{searchAddress(input: \\"Something\\", region:\\"Somewhere\\")}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(true);
    expect(response.errors).not.toBeDefined();
  });

  it("testing newsletterSignip, expect success", async () => {
    var query = `mutation{newsletterSignup(email:\\"testmail147@abv.bg\\"){ok}}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(true);
    expect(response.errors).not.toBeDefined();
    expect(response.data.newsletterSignup.ok).toEqual(true);
  });

  it("testing newsletterSignup with valid email, expect success", async () => {
    var query = `mutation{newsletterSignup(email:\\"testmail147@abv.bg\\"){ok}}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(true);
    expect(response.errors).not.toBeDefined();
    expect(response.data.newsletterSignup.ok).toEqual(true);
  });

  it("testing newsletterSignupConfirm with valid email and token, expect success", async () => {
    var query = `mutation{newsletterSignupConfirm(email:\\"testmail147@abv.bg\\", token: \\"ce025eba8a\\"){ok}}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(true);
    expect(response.errors).not.toBeDefined();
    expect(response.data.newsletterSignupConfirm.ok).toEqual(true);
  });

  it("testing newsletterSignupConfirm with invalid email, expect NormalError", async () => {
    var query = `mutation{newsletterSignupConfirm(email:\\"notanemail\\", token: \\"ce025eba8a\\"){ok}}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(false);
    expect(response.errors).toHaveLength(1);
    expect(response.errors[0].name).toEqual("NormalError");
    expect(response.data).toEqual(null);
  });

  it("testing newsletterSignupConfirm with valid email and invalid token, expect NormalError", async () => {
    var query = `mutation{newsletterSignupConfirm(email:\\"testmail147@abv.bg\\", token: \\"notavalidtoken\\"){ok}}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(false);
    expect(response.errors).toHaveLength(1);
    expect(response.errors[0].name).toEqual("NormalError");
    expect(response.data).toEqual(null);
  });

  it("testing contact with valid email, expect success", async () => {
    var query = `mutation{contact(email: \\"testmail147@abv.bg\\", company: \\"IntegrationTests\\", message:\\"Sorry!\\", type: \\"\\", name:\\"Test User\\")}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(true);
    expect(response.errors).not.toBeDefined();
    expect(response.data.contact).toEqual(true);
  });

  it("testing contact with invalid email, expect NormalError", async () => {
    var query = `mutation{contact(email: \\"notanemail\\", company: \\"IntegrationTests\\", message:\\"Sorry!\\", type: \\"\\", name:\\"Test User\\")}`;
    var response = await testing(queryWrapper(query));

    expect(response).toBeDefined();
    expect(response.status).toEqual(200);
    expect(response.success).toEqual(false);
    expect(response.errors).toHaveLength(1);
    expect(response.errors[0].name).toEqual("NormalError");
    expect(response.data).toEqual(null);
  });
});
